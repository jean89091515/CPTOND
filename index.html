<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPTOND-2025 | 中国公共交通网络数据集</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .lang-btn {
            background: none;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .lang-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .badge {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .doi-section {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .doi-section a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            animation: fadeInUp 1s ease-out;
        }

        .stat-card:hover {
            transform: translateY(-10px);
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 1s ease-out;
        }

        .section-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-title i {
            color: #667eea;
        }

        .map-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 25px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label i {
            color: #667eea;
        }

        .city-select {
            background: white;
            border: 2px solid #667eea;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            color: #333;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .city-select:hover {
            border-color: #4CAF50;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .transport-buttons {
            display: flex;
            gap: 10px;
        }

        .transport-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            flex: 1;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .transport-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .transport-btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .transport-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .layer-buttons {
            display: flex;
            gap: 8px;
        }

        .layer-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 0.9em;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .layer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .layer-btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .basemap-select {
            background: white;
            border: 2px solid #667eea;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 35px;
        }

        .basemap-select:hover {
            border-color: #4CAF50;
        }

        .map-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #map {
            width: 100%;
            height: 600px;
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            display: none;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .loading-indicator i {
            color: #667eea;
            margin-right: 10px;
        }

        .legend {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            line-height: 24px;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .legend h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend h4 i {
            color: #667eea;
        }

        .legend-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .legend-line {
            width: 25px;
            height: 4px;
            display: inline-block;
            margin-right: 10px;
            border-radius: 2px;
        }

        .legend-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .data-info-panel {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .data-attributes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .attribute-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .download-section {
            text-align: center;
            margin: 40px 0;
        }

        .download-btn {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            font-size: 1.1em;
            transition: transform 0.3s ease;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
            margin: 0 10px 10px 10px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }

        .footer {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .footer a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-size: 1.5em;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #ffd700;
        }

        .success-message, .info-message {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #2e7d32;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-message {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            color: #1a1f71;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 2px solid #f44336;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #c62828;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .section-title {
                font-size: 1.5em;
            }

            .map-controls {
                grid-template-columns: 1fr;
            }

            .transport-buttons {
                flex-direction: column;
            }

            .layer-buttons {
                flex-direction: column;
            }

            .download-btn {
                display: block;
                margin: 10px auto;
            }
        }

        .leaflet-popup-content-wrapper {
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- 语言切换器 -->
    <div class="language-switcher">
        <button class="lang-btn active" data-lang="zh">中文</button>
        <button class="lang-btn" data-lang="en">English</button>
    </div>

    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1><i class="fas fa-bus"></i> <span data-key="title">CPTOND-2025 中国公共交通网络数据集</span></h1>
            <p data-key="subtitle">China Public Transport Open Network Dataset - 2025</p>
            <div class="badges">
                <span class="badge"><i class="fas fa-file-code"></i> <span data-key="badge-shapefile">Shapefile格式</span></span>
                <span class="badge"><i class="fas fa-city"></i> <span data-key="badge-cities">350+城市覆盖</span></span>
                <span class="badge"><i class="fas fa-globe"></i> <span data-key="badge-coordinate">WGS84坐标系</span></span>
                <span class="badge"><i class="fas fa-subway"></i> <span data-key="badge-transport">公交地铁</span></span>
            </div>
            <div class="doi-section">
                <i class="fas fa-link"></i> 
                <strong>DOI:</strong> 
                <a href="https://figshare.com/articles/dataset/CPTOND-2025/29377427" target="_blank">
                    10.6084/m9.figshare.29377427
                </a>
            </div>
        </div>

        <!-- 统计数据 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-city"></i></div>
                <div class="stat-number" id="cityCount">350+</div>
                <div class="stat-label" data-key="stat-cities">覆盖城市</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-subway"></i></div>
                <div class="stat-number" id="metroCount">46</div>
                <div class="stat-label" data-key="stat-metro">地铁城市</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-route"></i></div>
                <div class="stat-number" id="routesLength">3.4M</div>
                <div class="stat-label" data-key="stat-routes">公里线路</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-crosshairs"></i></div>
                <div class="stat-number">5.08m</div>
                <div class="stat-label" data-key="stat-accuracy">平均精度</div>
            </div>
        </div>

        <!-- 在线地图预览 -->
        <div class="content-section">
            <h2 class="section-title">
                <i class="fas fa-map"></i>
                <span data-key="preview-title">在线数据预览</span>
            </h2>
            
            <div class="info-message">
                <i class="fas fa-info-circle"></i> 
                <span data-key="map-info">
                    <strong>交互式数据展示：</strong>选择城市和交通方式，实时加载并可视化全国公共交通网络数据。支持站点和线路图层切换。
                </span>
            </div>

            <div class="map-controls">
                <div class="control-group">
                    <label data-key="select-city" for="citySelect">
                        <i class="fas fa-city"></i>
                        选择城市
                    </label>
                    <select class="city-select" id="citySelect">
                        <option value="">-- 选择城市 --</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label data-key="transport-type">
                        <i class="fas fa-bus"></i>
                        交通类型
                    </label>
                    <div class="transport-buttons">
                        <button class="transport-btn active" data-transport="bus">
                            <i class="fas fa-bus"></i> <span data-key="btn-bus">公交</span>
                        </button>
                        <button class="transport-btn" data-transport="metro">
                            <i class="fas fa-subway"></i> <span data-key="btn-subway">地铁</span>
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label data-key="layer-type">
                        <i class="fas fa-layer-group"></i>
                        图层显示
                    </label>
                    <div class="layer-buttons">
                        <button class="layer-btn active" data-layer="stops">
                            <i class="fas fa-map-marker-alt"></i> <span data-key="btn-stops">站点</span>
                        </button>
                        <button class="layer-btn" data-layer="routes">
                            <i class="fas fa-route"></i> <span data-key="btn-routes">线路</span>
                        </button>
                        <button class="layer-btn" data-layer="both">
                            <i class="fas fa-layer-group"></i> <span data-key="btn-both">叠加</span>
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <label data-key="basemap-type" for="basemapSelect">
                        <i class="fas fa-map"></i>
                        底图样式
                    </label>
                    <select class="basemap-select" id="basemapSelect">
                        <option value="osm">OpenStreetMap</option>
                        <option value="carto-light">Carto简洁</option>
                        <option value="carto-dark">Carto深色</option>
                        <option value="esri-world">Esri世界地图</option>
                        <option value="esri-satellite">Esri卫星图</option>
                        <option value="stamen-toner">Stamen黑白</option>
                    </select>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
                <div class="loading-indicator" id="loadingIndicator">
                    <i class="fas fa-spinner fa-spin"></i> 
                    <span data-key="loading">数据加载中...</span>
                </div>
            </div>

            <div class="data-info-panel" id="dataInfo">
                <h3><i class="fas fa-info-circle"></i> <span data-key="data-attributes">数据属性信息</span></h3>
                <div id="currentDataInfo">
                    <div class="success-message">
                        <i class="fas fa-hand-pointer"></i>
                        <span data-key="select-prompt">请选择城市查看详细数据属性信息</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 数据说明 -->
        <div class="content-section">
            <h2 class="section-title">
                <i class="fas fa-info-circle"></i>
                <span data-key="dataset-info-title">数据集说明</span>
            </h2>
            
            <!-- 论文作者信息 -->
            <div class="author-section" style="background: rgba(102, 126, 234, 0.05); padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #667eea;">
                <h3 style="color: #333; margin-bottom: 15px;">
                    <i class="fas fa-users" style="color: #667eea; margin-right: 8px;"></i>
                    <span data-key="authors-title">论文作者</span>
                </h3>
                <div class="authors-content" data-lang-content="zh">
                    <p><strong>王亮</strong><sup>1,2</sup>，<strong>韦鹤</strong><sup>2</sup>，<strong>关宇</strong><sup>2</sup>，<strong>欧阳立斌</strong><sup>2</sup>，<strong>许丹丹</strong><sup>2</sup>，<strong>韩雪花</strong><sup>2</sup>，<strong>张敏</strong><sup>2</sup>，<strong>陈萌</strong><sup>2</sup>，<strong>孙道胜</strong><sup>2</sup>，<strong>龚大庆</strong><sup>1</sup>，<strong>张振基</strong><sup>1</sup>，<strong>张星华</strong><sup>*3</sup>，<strong>张晓东</strong><sup>*2,4</sup></p>
                    <div style="font-size: 0.9em; margin-top: 10px; line-height: 1.6;">
                        <p>1. 北京交通大学经济管理学院，北京，100044</p>
                        <p>2. 北京市城市规划设计研究院，北京，100045</p>
                        <p>3. 北京交通大学理学院，北京，100044</p>
                        <p>4. 清华大学建筑学院，北京，100084</p>
                    </div>
                </div>
                <div class="authors-content" data-lang-content="en" style="display: none;">
                    <p><strong>Liang Wang</strong><sup>1,2</sup>, <strong>He Wei</strong><sup>2</sup>, <strong>Yu Guan</strong><sup>2</sup>, <strong>Libin Ouyang</strong><sup>2</sup>, <strong>DanDan Xu</strong><sup>2</sup>, <strong>Xuehua Han</strong><sup>2</sup>, <strong>Min Zhang</strong><sup>2</sup>, <strong>Meng Chen</strong><sup>2</sup>, <strong>Daosheng Sun</strong><sup>2</sup>, <strong>Daqing Gong</strong><sup>1</sup>, <strong>Zhenji Zhang</strong><sup>1</sup>, <strong>Xinghua Zhang</strong><sup>*3</sup>, <strong>Xiaodong Zhang</strong><sup>*2,4</sup></p>
                    <div style="font-size: 0.9em; margin-top: 10px; line-height: 1.6;">
                        <p>1. School of Economics and Management, Beijing Jiaotong University, Beijing, 100044, China</p>
                        <p>2. Beijing Municipal Institute of City Planning and Design, Beijing, 100045, China</p>
                        <p>3. School of Physical Science and Engineering, Beijing Jiaotong University, Beijing, 100044, China</p>
                        <p>4. School of Architecture, Tsinghua University, Beijing, 100084, China</p>
                    </div>
                </div>
            </div>
            
            <div class="dataset-description" data-lang-content="zh">
                <p>CPTOND-2025是一个全面的中国公共交通网络开放数据集，系统性集成了中国大陆、香港、澳门、台湾地区350个城市的公交网络和46个城市的地铁系统数据。基于2025年6月数据收集，采用科学方法论整合专业平台和商业API，数据集涵盖约340.8万公里的运营线路（公交：约337.5万公里；地铁：约3.3万公里）。</p>
                
                <h3>数据特点：</h3>
                <ul>
                    <li><strong>高精度地理坐标：</strong>采用WGS-84坐标系，平均空间精度达到5.08米</li>
                    <li><strong>丰富的属性信息：</strong>包含运营时间、票价、运营公司等详细属性</li>
                    <li><strong>标准化格式：</strong>统一的Shapefile数据结构和命名规范</li>
                    <li><strong>多交通方式：</strong>涵盖公交和地铁两种主要城市交通方式</li>
                    <li><strong>全国覆盖：</strong>包含全国各省市区的主要城市公共交通数据</li>
                    <li><strong>双语支持：</strong>支持中英文双语属性记录</li>
                    <li><strong>开放获取：</strong>遵循开放科学原则，支持多样化应用</li>
                </ul>

                <h3>数据组织结构：</h3>
                <ul>
                    <li><strong>文件命名规范：</strong>{city_en}_bus_routes.shp, {city_en}_bus_stops.shp</li>
                    <li><strong>地铁数据：</strong>{city_en}_metro_routes.shp, {city_en}_metro_stops.shp</li>
                    <li><strong>坐标系统：</strong>WGS-84 (EPSG:4326) 地理坐标系</li>
                    <li><strong>编码格式：</strong>UTF-8 字符编码，支持中英文</li>
                    <li><strong>数据精度：</strong>空间定位精度平均5.08米</li>
                </ul>

                <h3>应用领域：</h3>
                <ul>
                    <li><strong>运营效率评估：</strong>支持公共交通运营效率分析和评估</li>
                    <li><strong>城市规划：</strong>为城市交通规划和可持续发展提供数据支撑</li>
                    <li><strong>学术研究：</strong>为城市交通研究提供高质量数据基础</li>
                    <li><strong>政策制定：</strong>支持交通政策分析和决策支持</li>
                </ul>
            </div>

            <div class="dataset-description" data-lang-content="en" style="display: none;">
                <p>CPTOND-2025 is a comprehensive open dataset of China's public transport operation networks, systematically integrating bus networks from 350 cities and metro systems from 46 cities across mainland China, Hong Kong, Macao, and Taiwan regions. Based on June 2025 data collection using scientific methodologies integrating professional platforms and commercial APIs, the dataset encompasses approximately 3,408,000 kilometers of operational routes (bus: ~3,375,000 km; metro: ~33,000 km).</p>
                
                <h3>Data Features:</h3>
                <ul>
                    <li><strong>High-precision geographic coordinates:</strong> Using WGS-84 coordinate system with average spatial accuracy of 5.08 meters</li>
                    <li><strong>Rich attribute information:</strong> Including operating hours, fares, operating companies and other detailed attributes</li>
                    <li><strong>Standardized format:</strong> Unified Shapefile data structure and naming conventions</li>
                    <li><strong>Multi-transport modes:</strong> Covering bus and metro, the two main urban transport modes</li>
                    <li><strong>National coverage:</strong> Including major cities' public transport data across all provinces and regions</li>
                    <li><strong>Bilingual support:</strong> Supporting Chinese and English attribute records</li>
                    <li><strong>Open access:</strong> Following open science principles, supporting diverse applications</li>
                </ul>

                <h3>Data Organization:</h3>
                <ul>
                    <li><strong>File naming convention:</strong> {city_en}_bus_routes.shp, {city_en}_bus_stops.shp</li>
                    <li><strong>Metro data:</strong> {city_en}_metro_routes.shp, {city_en}_metro_stops.shp</li>
                    <li><strong>Coordinate system:</strong> WGS-84 (EPSG:4326) geographic coordinate system</li>
                    <li><strong>Encoding format:</strong> UTF-8 character encoding, supporting Chinese and English</li>
                    <li><strong>Data accuracy:</strong> Average spatial positioning accuracy of 5.08 meters</li>
                </ul>

                <h3>Application Areas:</h3>
                <ul>
                    <li><strong>Operation efficiency assessment:</strong> Supporting public transport operation efficiency analysis and evaluation</li>
                    <li><strong>Urban planning:</strong> Providing data support for urban transport planning and sustainable development</li>
                    <li><strong>Academic research:</strong> Providing high-quality data foundation for urban transport research</li>
                    <li><strong>Policy making:</strong> Supporting transport policy analysis and decision support</li>
                </ul>
            </div>
        </div>

        <!-- 下载部分 -->
        <div class="download-section">
            <a href="https://figshare.com/articles/dataset/CPTOND-2025/29377427?file=56306825" class="download-btn" target="_blank">
                <i class="fas fa-download"></i> <span data-key="download-dataset">下载完整数据集</span>
            </a>
            <a href="https://figshare.com/articles/dataset/CPTOND-2025/29377427" class="download-btn" target="_blank">
                <i class="fas fa-external-link-alt"></i> <span data-key="view-figshare">查看Figshare页面</span>
            </a>
            <a href="https://test.bgyoa.xyz/geojson/" class="download-btn" target="_blank">
                <i class="fas fa-code"></i> <span data-key="view-raw-data">查看原始数据</span>
            </a>
        </div>
    </div>

    <!-- 页脚 -->
    <div class="footer">
        <p>&copy; 2025 CPTOND-2025 <span data-key="footer-project">数据集项目</span></p>
        <div style="margin-top: 15px;">
            <a href="https://figshare.com/articles/dataset/CPTOND-2025/29377427" title="Figshare">
                <i class="fas fa-database"></i>
            </a>
            <a href="mailto:wljean@126.com" title="Email">
                <i class="fas fa-envelope"></i>
            </a>
            <a href="https://test.bgyoa.xyz/geojson/" title="Raw Data">
                <i class="fas fa-map"></i>
            </a>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // ==================== 配置常量 ====================
        const SERVER_BASE_URL = 'https://test.bgyoa.xyz/geojson/';

        // 多语言翻译
        const translations = {
            zh: {
                'title': 'CPTOND-2025 中国公共交通网络数据集',
                'subtitle': 'China Public Transport Open Network Dataset - 2025',
                'badge-shapefile': 'Shapefile格式',
                'badge-cities': '350+城市覆盖',
                'badge-coordinate': 'WGS84坐标系',
                'badge-transport': '公交地铁',
                'stat-cities': '覆盖城市',
                'stat-metro': '地铁城市',
                'stat-routes': '公里线路',
                'stat-accuracy': '平均精度',
                'preview-title': '在线数据预览',
                'select-city': '选择城市',
                'transport-type': '交通类型',
                'layer-type': '图层显示',
                'basemap-type': '底图样式',
                'btn-bus': '公交',
                'btn-subway': '地铁',
                'btn-stops': '站点',
                'btn-routes': '线路',
                'btn-both': '叠加',
                'loading': '数据加载中...',
                'data-attributes': '数据属性信息',
                'select-prompt': '请选择城市查看详细数据属性信息',
                'map-info': '<strong>交互式数据展示：</strong>选择城市和交通方式，实时加载并可视化全国公共交通网络数据。支持站点和线路图层切换。',
                'dataset-info-title': '数据集说明',
                'authors-title': '论文作者',
                'download-dataset': '下载完整数据集',
                'view-figshare': '查看Figshare页面',
                'view-raw-data': '查看原始数据',
                'footer-project': '数据集项目'
            },
            en: {
                'title': 'CPTOND-2025 China Public Transport Network Dataset',
                'subtitle': 'Open Geographic Dataset for Chinese Urban Transit Systems',
                'badge-shapefile': 'Shapefile Format',
                'badge-cities': '350+ Cities Coverage',
                'badge-coordinate': 'WGS-84 Coordinate',
                'badge-transport': 'Bus & Metro',
                'stat-cities': 'Cities Covered',
                'stat-metro': 'Metro Cities',
                'stat-routes': 'Km Routes',
                'stat-accuracy': 'Average Accuracy',
                'preview-title': 'Online Data Preview',
                'select-city': 'Select City',
                'transport-type': 'Transport Type',
                'layer-type': 'Layer Display',
                'basemap-type': 'Basemap Style',
                'btn-bus': 'Bus',
                'btn-subway': 'Metro',
                'btn-stops': 'Stops',
                'btn-routes': 'Routes',
                'btn-both': 'Overlay',
                'loading': 'Loading data...',
                'data-attributes': 'Data Attributes',
                'select-prompt': 'Please select a city to view detailed data attributes',
                'map-info': '<strong>Interactive Data Display:</strong> Select cities and transport modes to load and visualize national public transport network data in real-time. Supports switching between stops and routes layers.',
                'dataset-info-title': 'Dataset Information',
                'authors-title': 'Research Authors',
                'download-dataset': 'Download Full Dataset',
                'view-figshare': 'View Figshare Page',
                'view-raw-data': 'View Raw Data',
                'footer-project': 'Dataset Project'
            }
        };

        // 城市数据配置（所有城市的坐标和缩放级别）
        const cities = {
            'zunyi': { name_cn: '遵义', name_en: 'Zunyi', lat: 27.7251, lng: 106.9313, zoom: 11 },
            'ziyang': { name_cn: '资阳', name_en: 'Ziyang', lat: 30.1275, lng: 104.6544, zoom: 11 },
            'zigong': { name_cn: '自贡', name_en: 'Zigong', lat: 29.3587, lng: 104.7788, zoom: 11 },
            'zibo': { name_cn: '淄博', name_en: 'Zibo', lat: 36.8131, lng: 118.0548, zoom: 11 },
            'zhuzhou': { name_cn: '株洲', name_en: 'Zhuzhou', lat: 27.8274, lng: 113.1338, zoom: 11 },
            'zhumadian': { name_cn: '驻马店', name_en: 'Zhumadian', lat: 32.9773, lng: 114.0193, zoom: 11 },
            'zhuhai': { name_cn: '珠海', name_en: 'Zhuhai', lat: 22.2769, lng: 113.5678, zoom: 11 },
            'zhoushan': { name_cn: '舟山', name_en: 'Zhoushan', lat: 29.9853, lng: 122.2072, zoom: 11 },
            'zhoukou': { name_cn: '周口', name_en: 'Zhoukou', lat: 33.6204, lng: 114.6966, zoom: 11 },
            'zhongshan': { name_cn: '中山', name_en: 'Zhongshan', lat: 22.5175, lng: 113.3927, zoom: 11 },
            'zhenjiang': { name_cn: '镇江', name_en: 'Zhenjiang', lat: 32.1853, lng: 119.4252, zoom: 11 },
            'zhengzhou': { name_cn: '郑州', name_en: 'Zhengzhou', lat: 34.7466, lng: 113.6253, zoom: 10 },
            'zhaotong': { name_cn: '昭通', name_en: 'Zhaotong', lat: 27.3389, lng: 103.7178, zoom: 11 },
            'zhaoqing': { name_cn: '肇庆', name_en: 'Zhaoqing', lat: 23.0479, lng: 112.4664, zoom: 11 },
            'zhanjiang': { name_cn: '湛江', name_en: 'Zhanjiang', lat: 21.2707, lng: 110.3592, zoom: 11 },
            'zhangzhou': { name_cn: '漳州', name_en: 'Zhangzhou', lat: 24.5133, lng: 117.6472, zoom: 11 },
            'zhangye': { name_cn: '张掖', name_en: 'Zhangye', lat: 38.9325, lng: 100.4495, zoom: 11 },
            'zhangjiakou': { name_cn: '张家口', name_en: 'Zhangjiakou', lat: 40.8118, lng: 114.8794, zoom: 11 },
            'zhangjiajie': { name_cn: '张家界', name_en: 'Zhangjiajie', lat: 29.1274, lng: 110.4782, zoom: 11 },
            'zaozhuang': { name_cn: '枣庄', name_en: 'Zaozhuang', lat: 34.8107, lng: 117.3233, zoom: 11 },
            'yuxi': { name_cn: '玉溪', name_en: 'Yuxi', lat: 24.3520, lng: 102.5461, zoom: 11 },
            'yunfu': { name_cn: '云浮', name_en: 'Yunfu', lat: 22.9297, lng: 112.0442, zoom: 11 },
            'yuncheng': { name_cn: '运城', name_en: 'Yuncheng', lat: 35.0228, lng: 111.0073, zoom: 11 },
            'fuzhou': { name_cn: '福州', name_en: 'Fuzhou', lat: 26.0748, lng: 119.2965, zoom: 10 },
            'yueyang': { name_cn: '岳阳', name_en: 'Yueyang', lat: 29.3570, lng: 113.1281, zoom: 11 },
            'yongzhou': { name_cn: '永州', name_en: 'Yongzhou', lat: 26.4204, lng: 111.6085, zoom: 11 },
            'yiyang': { name_cn: '益阳', name_en: 'Yiyang', lat: 28.5701, lng: 112.3550, zoom: 11 },
            'yingkou': { name_cn: '营口', name_en: 'Yingkou', lat: 40.6673, lng: 122.2350, zoom: 11 },
            'yinchuan': { name_cn: '银川', name_en: 'Yinchuan', lat: 38.4872, lng: 106.2309, zoom: 11 },
            'suzhou': { name_cn: '苏州', name_en: 'Suzhou', lat: 31.2989, lng: 120.5853, zoom: 10 },
            'yichang': { name_cn: '宜昌', name_en: 'Yichang', lat: 30.7019, lng: 111.2905, zoom: 11 },
            'yibin': { name_cn: '宜宾', name_en: 'Yibin', lat: 28.7609, lng: 104.6308, zoom: 11 },
            'yantai': { name_cn: '烟台', name_en: 'Yantai', lat: 37.4638, lng: 121.4487, zoom: 11 },
            'yangzhou': { name_cn: '扬州', name_en: 'Yangzhou', lat: 32.3932, lng: 119.4215, zoom: 11 },
            'yangjiang': { name_cn: '阳江', name_en: 'Yangjiang', lat: 21.8573, lng: 111.9821, zoom: 11 },
            'yancheng': { name_cn: '盐城', name_en: 'Yancheng', lat: 33.3477, lng: 120.1634, zoom: 11 },
            'xuzhou': { name_cn: '徐州', name_en: 'Xuzhou', lat: 34.2056, lng: 117.2840, zoom: 11 },
            'xuchang': { name_cn: '许昌', name_en: 'Xuchang', lat: 34.0357, lng: 113.8526, zoom: 11 },
            'xuancheng': { name_cn: '宣城', name_en: 'Xuancheng', lat: 30.9457, lng: 118.7589, zoom: 11 },
            'xinzhou': { name_cn: '忻州', name_en: 'Xinzhou', lat: 38.4177, lng: 112.7334, zoom: 11 },
            'xinyu': { name_cn: '新余', name_en: 'Xinyu', lat: 27.8175, lng: 114.9169, zoom: 11 },
            'xinyang': { name_cn: '信阳', name_en: 'Xinyang', lat: 32.1234, lng: 114.0758, zoom: 11 },
            'xinxiang': { name_cn: '新乡', name_en: 'Xinxiang', lat: 35.3026, lng: 113.9268, zoom: 11 },
            'xining': { name_cn: '西宁', name_en: 'Xining', lat: 36.6174, lng: 101.7782, zoom: 11 },
            'xingtai': { name_cn: '邢台', name_en: 'Xingtai', lat: 37.0682, lng: 114.5048, zoom: 11 },
            'xiaogan': { name_cn: '孝感', name_en: 'Xiaogan', lat: 30.9264, lng: 113.9169, zoom: 11 },
            'xianning': { name_cn: '咸宁', name_en: 'Xianning', lat: 29.8426, lng: 114.3225, zoom: 11 },
            'xiangyang': { name_cn: '襄阳', name_en: 'Xiangyang', lat: 32.0090, lng: 112.1226, zoom: 11 },
            'xiangtan': { name_cn: '湘潭', name_en: 'Xiangtan', lat: 27.8294, lng: 112.9448, zoom: 11 },
            'xiamen': { name_cn: '厦门', name_en: 'Xiamen', lat: 24.4798, lng: 118.0819, zoom: 11 },
            'wuzhou': { name_cn: '梧州', name_en: 'Wuzhou', lat: 23.4742, lng: 111.2792, zoom: 11 },
            'wuxi': { name_cn: '无锡', name_en: 'Wuxi', lat: 31.4912, lng: 120.3124, zoom: 11 },
            'wuhu': { name_cn: '芜湖', name_en: 'Wuhu', lat: 31.3260, lng: 118.3721, zoom: 11 },
            'wuhan': { name_cn: '武汉', name_en: 'Wuhan', lat: 30.5928, lng: 114.3055, zoom: 10 },
            'wenzhou': { name_cn: '温州', name_en: 'Wenzhou', lat: 28.0000, lng: 120.6700, zoom: 11 },
            'weinan': { name_cn: '渭南', name_en: 'Weinan', lat: 34.4992, lng: 109.5097, zoom: 11 },
            'weihai': { name_cn: '威海', name_en: 'Weihai', lat: 37.5137, lng: 122.1201, zoom: 11 },
            'weifang': { name_cn: '潍坊', name_en: 'Weifang', lat: 36.7069, lng: 119.1019, zoom: 11 },
            'urumchi': { name_cn: '乌鲁木齐', name_en: 'Urumqi', lat: 43.7793, lng: 87.6177, zoom: 11 },
            'ulanqab': { name_cn: '乌兰察布', name_en: 'Ulanqab', lat: 40.9945, lng: 113.1337, zoom: 11 },
            'turpan': { name_cn: '吐鲁番', name_en: 'Turpan', lat: 42.9513, lng: 89.1898, zoom: 11 },
            'tongren': { name_cn: '铜仁', name_en: 'Tongren', lat: 27.7183, lng: 109.1918, zoom: 11 },
            'tongling': { name_cn: '铜陵', name_en: 'Tongling', lat: 30.9459, lng: 117.8164, zoom: 11 },
            'tongliao': { name_cn: '通辽', name_en: 'Tongliao', lat: 43.6174, lng: 122.2632, zoom: 11 },
            'tonghua': { name_cn: '通化', name_en: 'Tonghua', lat: 41.7211, lng: 125.9365, zoom: 11 },
            'tongchuan': { name_cn: '铜川', name_en: 'Tongchuan', lat: 34.8969, lng: 108.9453, zoom: 11 },
            'tieling': { name_cn: '铁岭', name_en: 'Tieling', lat: 42.2904, lng: 123.8448, zoom: 11 },
            'tianshui': { name_cn: '天水', name_en: 'Tianshui', lat: 34.5804, lng: 105.7250, zoom: 11 },
            'tianjin': { name_cn: '天津', name_en: 'Tianjin', lat: 39.3434, lng: 117.3616, zoom: 10 },
            'tangshan': { name_cn: '唐山', name_en: 'Tangshan', lat: 39.6358, lng: 118.1750, zoom: 11 },
            'taizhou': { name_cn: '台州', name_en: 'Taizhou', lat: 28.6568, lng: 121.4207, zoom: 11 },
            'taiyuan': { name_cn: '太原', name_en: 'Taiyuan', lat: 37.8706, lng: 112.5489, zoom: 11 },
            'yichun': { name_cn: '宜春', name_en: 'Yichun', lat: 27.8043, lng: 114.3916, zoom: 11 },
            'suqian': { name_cn: '宿迁', name_en: 'Suqian', lat: 33.9630, lng: 118.2752, zoom: 11 },
            'suining': { name_cn: '遂宁', name_en: 'Suining', lat: 30.5332, lng: 105.5713, zoom: 11 },
            'suihua': { name_cn: '绥化', name_en: 'Suihua', lat: 46.6374, lng: 126.9927, zoom: 11 },
            'siping': { name_cn: '四平', name_en: 'Siping', lat: 43.1703, lng: 124.3506, zoom: 11 },
            'shuozhou': { name_cn: '朔州', name_en: 'Shuozhou', lat: 39.3312, lng: 112.4331, zoom: 11 },
            'shuangyashan': { name_cn: '双鸭山', name_en: 'Shuangyashan', lat: 46.6434, lng: 131.1571, zoom: 11 },
            'shiyan': { name_cn: '十堰', name_en: 'Shiyan', lat: 32.6292, lng: 110.7989, zoom: 11 },
            'shijiazhuang': { name_cn: '石家庄', name_en: 'Shijiazhuang', lat: 38.0428, lng: 114.5149, zoom: 10 },
            'shihezi': { name_cn: '石河子', name_en: 'Shihezi', lat: 44.3059, lng: 86.0370, zoom: 11 },
            'shenzhen': { name_cn: '深圳', name_en: 'Shenzhen', lat: 22.5431, lng: 114.0579, zoom: 10 },
            'shenyang': { name_cn: '沈阳', name_en: 'Shenyang', lat: 41.8057, lng: 123.4315, zoom: 10 },
            'shaoyang': { name_cn: '邵阳', name_en: 'Shaoyang', lat: 27.2389, lng: 111.4677, zoom: 11 },
            'shaoxing': { name_cn: '绍兴', name_en: 'Shaoxing', lat: 30.0021, lng: 120.5820, zoom: 11 },
            'shaoguan': { name_cn: '韶关', name_en: 'Shaoguan', lat: 24.8138, lng: 113.5917, zoom: 11 },
            'shanwei': { name_cn: '汕尾', name_en: 'Shanwei', lat: 22.7863, lng: 115.3647, zoom: 11 },
            'shantou': { name_cn: '汕头', name_en: 'Shantou', lat: 23.3540, lng: 116.6817, zoom: 11 },
            'shangrao': { name_cn: '上饶', name_en: 'Shangrao', lat: 28.4419, lng: 117.9429, zoom: 11 },
            'shangqiu': { name_cn: '商丘', name_en: 'Shangqiu', lat: 34.4143, lng: 115.6500, zoom: 11 },
            'shangluo': { name_cn: '商洛', name_en: 'Shangluo', lat: 33.8614, lng: 109.9400, zoom: 11 },
            'shanghai': { name_cn: '上海', name_en: 'Shanghai', lat: 31.2304, lng: 121.4737, zoom: 10 },
            'sanya': { name_cn: '三亚', name_en: 'Sanya', lat: 18.2477, lng: 109.5082, zoom: 11 },
            'sanming': { name_cn: '三明', name_en: 'Sanming', lat: 26.2654, lng: 117.6385, zoom: 11 },
            'sanmenxia': { name_cn: '三门峡', name_en: 'Sanmenxia', lat: 34.7733, lng: 111.1944, zoom: 11 },
            'quzhou': { name_cn: '衢州', name_en: 'Quzhou', lat: 28.9419, lng: 118.8728, zoom: 11 },
            'qujing': { name_cn: '曲靖', name_en: 'Qujing', lat: 25.4901, lng: 103.7967, zoom: 11 },
            'quanzhou': { name_cn: '泉州', name_en: 'Quanzhou', lat: 24.8740, lng: 118.6758, zoom: 11 },
            'qiqihar': { name_cn: '齐齐哈尔', name_en: 'Qiqihar', lat: 47.3540, lng: 123.9180, zoom: 11 },
            'qionghai': { name_cn: '琼海', name_en: 'Qionghai', lat: 19.2459, lng: 110.4665, zoom: 11 },
            'qinzhou': { name_cn: '钦州', name_en: 'Qinzhou', lat: 21.9570, lng: 108.6242, zoom: 11 },
            'qinhuangdao': { name_cn: '秦皇岛', name_en: 'Qinhuangdao', lat: 39.9385, lng: 119.6011, zoom: 11 },
            'qingyuan': { name_cn: '清远', name_en: 'Qingyuan', lat: 23.7019, lng: 113.0365, zoom: 11 },
            'qingyang': { name_cn: '庆阳', name_en: 'Qingyang', lat: 35.7089, lng: 107.6441, zoom: 11 },
            'qingdao': { name_cn: '青岛', name_en: 'Qingdao', lat: 36.0671, lng: 120.3826, zoom: 10 },
            'qianjiang': { name_cn: '潜江', name_en: 'Qianjiang', lat: 30.4210, lng: 112.8969, zoom: 11 },
            'puyang': { name_cn: '濮阳', name_en: 'Puyang', lat: 35.7615, lng: 115.0417, zoom: 11 },
            'putian': { name_cn: '莆田', name_en: 'Putian', lat: 25.4541, lng: 119.0078, zoom: 11 },
            'pingxiang': { name_cn: '萍乡', name_en: 'Pingxiang', lat: 27.6229, lng: 113.8520, zoom: 11 },
            'panzhihua': { name_cn: '攀枝花', name_en: 'Panzhihua', lat: 26.5804, lng: 101.7183, zoom: 11 },
            'panjin': { name_cn: '盘锦', name_en: 'Panjin', lat: 41.1243, lng: 122.0570, zoom: 11 },
            'ordos': { name_cn: '鄂尔多斯', name_en: 'Ordos', lat: 39.6086, lng: 109.7811, zoom: 11 },
            'ningde': { name_cn: '宁德', name_en: 'Ningde', lat: 26.6617, lng: 119.5272, zoom: 11 },
            'ningbo': { name_cn: '宁波', name_en: 'Ningbo', lat: 29.8683, lng: 121.5440, zoom: 10 },
            'neijiang': { name_cn: '内江', name_en: 'Neijiang', lat: 29.5806, lng: 105.0584, zoom: 11 },
            'nanyang': { name_cn: '南阳', name_en: 'Nanyang', lat: 32.9909, lng: 112.5288, zoom: 11 },
            'nantong': { name_cn: '南通', name_en: 'Nantong', lat: 32.0116, lng: 120.8644, zoom: 11 },
            'nanping': { name_cn: '南平', name_en: 'Nanping', lat: 26.6435, lng: 118.1782, zoom: 11 },
            'nanning': { name_cn: '南宁', name_en: 'Nanning', lat: 22.8170, lng: 108.3665, zoom: 10 },
            'nanjing': { name_cn: '南京', name_en: 'Nanjing', lat: 32.0603, lng: 118.7969, zoom: 10 },
            'nanchong': { name_cn: '南充', name_en: 'Nanchong', lat: 30.7953, lng: 106.0825, zoom: 11 },
            'nanchang': { name_cn: '南昌', name_en: 'Nanchang', lat: 28.6820, lng: 115.8581, zoom: 10 },
            'mudanjiang': { name_cn: '牡丹江', name_en: 'Mudanjiang', lat: 44.5513, lng: 129.6338, zoom: 11 },
            'mianyang': { name_cn: '绵阳', name_en: 'Mianyang', lat: 31.4677, lng: 104.6794, zoom: 11 },
            'meizhou': { name_cn: '梅州', name_en: 'Meizhou', lat: 24.2997, lng: 116.1255, zoom: 11 },
            'meishan': { name_cn: '眉山', name_en: 'Meishan', lat: 30.0756, lng: 103.8312, zoom: 11 },
            'maoming': { name_cn: '茂名', name_en: 'Maoming', lat: 21.6688, lng: 110.9255, zoom: 11 },
            'macau': { name_cn: '澳门', name_en: 'Macau', lat: 22.1987, lng: 113.5439, zoom: 11 },
            'luzhou': { name_cn: '泸州', name_en: 'Luzhou', lat: 28.8718, lng: 105.4433, zoom: 11 },
            'luoyang': { name_cn: '洛阳', name_en: 'Luoyang', lat: 34.6197, lng: 112.4540, zoom: 11 },
            'luohe': { name_cn: '漯河', name_en: 'Luohe', lat: 33.5813, lng: 114.0164, zoom: 11 },
            'loudi': { name_cn: '娄底', name_en: 'Loudi', lat: 27.7281, lng: 111.9939, zoom: 11 },
            'longyan': { name_cn: '龙岩', name_en: 'Longyan', lat: 25.0918, lng: 117.0174, zoom: 11 },
            'longnan': { name_cn: '陇南', name_en: 'Longnan', lat: 33.3886, lng: 104.9214, zoom: 11 },
            'liuzhou': { name_cn: '柳州', name_en: 'Liuzhou', lat: 24.3146, lng: 109.4281, zoom: 11 },
            'linyi': { name_cn: '临沂', name_en: 'Linyi', lat: 35.1041, lng: 118.3563, zoom: 11 },
            'linfen': { name_cn: '临汾', name_en: 'Linfen', lat: 36.0881, lng: 111.5189, zoom: 11 },
            'lincang': { name_cn: '临沧', name_en: 'Lincang', lat: 23.8878, lng: 100.0868, zoom: 11 },
            'lijiang': { name_cn: '丽江', name_en: 'Lijiang', lat: 26.8551, lng: 100.2270, zoom: 11 },
            'liaoyuan': { name_cn: '辽源', name_en: 'Liaoyuan', lat: 42.9027, lng: 125.1458, zoom: 11 },
            'liaoyang': { name_cn: '辽阳', name_en: 'Liaoyang', lat: 41.2694, lng: 123.1769, zoom: 11 },
            'liaocheng': { name_cn: '聊城', name_en: 'Liaocheng', lat: 36.4570, lng: 115.9850, zoom: 11 },
            'lianyungang': { name_cn: '连云港', name_en: 'Lianyungang', lat: 34.5967, lng: 119.2216, zoom: 11 },
            'lhasa': { name_cn: '拉萨', name_en: 'Lhasa', lat: 29.6520, lng: 91.1721, zoom: 11 },
            'leshan': { name_cn: '乐山', name_en: 'Leshan', lat: 29.5522, lng: 103.7614, zoom: 11 },
            'lanzhou': { name_cn: '兰州', name_en: 'Lanzhou', lat: 36.0611, lng: 103.8343, zoom: 11 },
            'langfang': { name_cn: '廊坊', name_en: 'Langfang', lat: 39.5237, lng: 116.7030, zoom: 11 },
            'kunming': { name_cn: '昆明', name_en: 'Kunming', lat: 25.0389, lng: 102.7183, zoom: 10 },
            'kashi': { name_cn: '喀什', name_en: 'Kashi', lat: 39.4677, lng: 75.9930, zoom: 11 },
            'karamay': { name_cn: '克拉玛依', name_en: 'Karamay', lat: 45.5946, lng: 84.8892, zoom: 11 },
            'kaifeng': { name_cn: '开封', name_en: 'Kaifeng', lat: 34.7971, lng: 114.3074, zoom: 11 },
            'jiyuan': { name_cn: '济源', name_en: 'Jiyuan', lat: 35.0904, lng: 112.6020, zoom: 11 },
            'jiuquan': { name_cn: '酒泉', name_en: 'Jiuquan', lat: 39.7432, lng: 98.4951, zoom: 11 },
            'jiujiang': { name_cn: '九江', name_en: 'Jiujiang', lat: 29.705, lng: 115.9929, zoom: 11 },
            'jinzhou': { name_cn: '锦州', name_en: 'Jinzhou', lat: 41.0956, lng: 121.1267, zoom: 11 },
            'jinzhong': { name_cn: '晋中', name_en: 'Jinzhong', lat: 37.6965, lng: 112.7537, zoom: 11 },
            'jining': { name_cn: '济宁', name_en: 'Jining', lat: 35.4154, lng: 116.5875, zoom: 11 },
            'jinhua': { name_cn: '金华', name_en: 'Jinhua', lat: 29.1087, lng: 119.6473, zoom: 11 },
            'jingzhou': { name_cn: '荆州', name_en: 'Jingzhou', lat: 30.3264, lng: 112.2386, zoom: 11 },
            'jingmen': { name_cn: '荆门', name_en: 'Jingmen', lat: 31.0354, lng: 112.2047, zoom: 11 },
            'jingdezhen': { name_cn: '景德镇', name_en: 'Jingdezhen', lat: 29.2947, lng: 117.2142, zoom: 11 },
            'jincheng': { name_cn: '晋城', name_en: 'Jincheng', lat: 35.4977, lng: 112.8515, zoom: 11 },
            'jinchang': { name_cn: '金昌', name_en: 'Jinchang', lat: 38.5142, lng: 102.1878, zoom: 11 },
            'jinan': { name_cn: '济南', name_en: 'Jinan', lat: 36.6512, lng: 117.1201, zoom: 10 },
            'jilin': { name_cn: '吉林', name_en: 'Jilin', lat: 43.8376, lng: 126.5494, zoom: 11 },
            'jieyang': { name_cn: '揭阳', name_en: 'Jieyang', lat: 23.5418, lng: 116.3726, zoom: 11 },
            'jiayuguan': { name_cn: '嘉峪关', name_en: 'Jiayuguan', lat: 39.7736, lng: 98.2897, zoom: 11 },
            'jiaxing': { name_cn: '嘉兴', name_en: 'Jiaxing', lat: 30.7469, lng: 120.7506, zoom: 11 },
            'jiaozuo': { name_cn: '焦作', name_en: 'Jiaozuo', lat: 35.2159, lng: 113.2417, zoom: 11 },
            'jiangmen': { name_cn: '江门', name_en: 'Jiangmen', lat: 22.5751, lng: 113.0946, zoom: 11 },
            'jiamusi': { name_cn: '佳木斯', name_en: 'Jiamusi', lat: 46.7992, lng: 130.3182, zoom: 11 },
            'huzhou': { name_cn: '湖州', name_en: 'Huzhou', lat: 30.8703, lng: 120.0985, zoom: 11 },
            'hulunbuir': { name_cn: '呼伦贝尔', name_en: 'Hulunbuir', lat: 49.2112, lng: 119.7651, zoom: 11 },
            'huludao': { name_cn: '葫芦岛', name_en: 'Huludao', lat: 40.7115, lng: 120.8368, zoom: 11 },
            'huizhou': { name_cn: '惠州', name_en: 'Huizhou', lat: 23.0794, lng: 114.4165, zoom: 11 },
            'huangshan': { name_cn: '黄山', name_en: 'Huangshan', lat: 29.7144, lng: 118.3377, zoom: 11 },
            'huanggang': { name_cn: '黄冈', name_en: 'Huanggang', lat: 30.4477, lng: 114.8722, zoom: 11 },
            'huainan': { name_cn: '淮南', name_en: 'Huainan', lat: 32.6266, lng: 116.9969, zoom: 11 },
            'huaihua': { name_cn: '怀化', name_en: 'Huaihua', lat: 27.5504, lng: 109.9980, zoom: 11 },
            'huaibei': { name_cn: '淮北', name_en: 'Huaibei', lat: 33.9547, lng: 116.7918, zoom: 11 },
            'hohhot': { name_cn: '呼和浩特', name_en: 'Hohhot', lat: 40.8423, lng: 111.7522, zoom: 11 },
            'hezhou': { name_cn: '贺州', name_en: 'Hezhou', lat: 24.4144, lng: 111.5527, zoom: 11 },
            'heze': { name_cn: '菏泽', name_en: 'Heze', lat: 35.2333, lng: 115.4690, zoom: 11 },
            'hengyang': { name_cn: '衡阳', name_en: 'Hengyang', lat: 26.9005, lng: 112.6072, zoom: 11 },
            'hengshui': { name_cn: '衡水', name_en: 'Hengshui', lat: 37.7351, lng: 115.6656, zoom: 11 },
            'hegang': { name_cn: '鹤岗', name_en: 'Hegang', lat: 47.3321, lng: 130.2772, zoom: 11 },
            'hefei': { name_cn: '合肥', name_en: 'Hefei', lat: 31.8206, lng: 117.2272, zoom: 10 },
            'hebi': { name_cn: '鹤壁', name_en: 'Hebi', lat: 35.7483, lng: 114.2974, zoom: 11 },
            'harbin': { name_cn: '哈尔滨', name_en: 'Harbin', lat: 45.8038, lng: 126.5349, zoom: 10 },
            'hanzhong': { name_cn: '汉中', name_en: 'Hanzhong', lat: 33.0777, lng: 107.0283, zoom: 11 },
            'hangzhou': { name_cn: '杭州', name_en: 'Hangzhou', lat: 30.2741, lng: 120.1551, zoom: 10 },
            'handan': { name_cn: '邯郸', name_en: 'Handan', lat: 36.6253, lng: 114.5389, zoom: 11 },
            'hami': { name_cn: '哈密', name_en: 'Hami', lat: 42.8335, lng: 93.5281, zoom: 11 },
            'haikou': { name_cn: '海口', name_en: 'Haikou', lat: 20.0458, lng: 110.3417, zoom: 11 },
            'haidong': { name_cn: '海东', name_en: 'Haidong', lat: 36.5029, lng: 102.1040, zoom: 11 },
            'guyuan': { name_cn: '固原', name_en: 'Guyuan', lat: 36.0040, lng: 106.2853, zoom: 11 },
            'guiyang': { name_cn: '贵阳', name_en: 'Guiyang', lat: 26.6470, lng: 106.6302, zoom: 10 },
            'guilin': { name_cn: '桂林', name_en: 'Guilin', lat: 25.2736, lng: 110.2900, zoom: 11 },
            'guigang': { name_cn: '贵港', name_en: 'Guigang', lat: 23.0939, lng: 109.6024, zoom: 11 },
            'guangzhou': { name_cn: '广州', name_en: 'Guangzhou', lat: 23.1291, lng: 113.2644, zoom: 10 },
            'guangyuan': { name_cn: '广元', name_en: 'Guangyuan', lat: 32.4353, lng: 105.8297, zoom: 11 },
            'ganzhou': { name_cn: '赣州', name_en: 'Ganzhou', lat: 25.8452, lng: 114.9346, zoom: 11 },
            'yulin': { name_cn: '玉林', name_en: 'Yulin', lat: 22.6293, lng: 110.1507, zoom: 11 },
            'fuyang': { name_cn: '阜阳', name_en: 'Fuyang', lat: 32.9003, lng: 115.8170, zoom: 11 },
            'fuxin': { name_cn: '阜新', name_en: 'Fuxin', lat: 42.0118, lng: 121.6708, zoom: 11 },
            'fushun': { name_cn: '抚顺', name_en: 'Fushun', lat: 41.8773, lng: 123.9574, zoom: 11 },
            'foshan': { name_cn: '佛山', name_en: 'Foshan', lat: 23.0218, lng: 113.1064, zoom: 11 },
            'fangchenggang': { name_cn: '防城港', name_en: 'Fangchenggang', lat: 21.6147, lng: 108.3548, zoom: 11 },
            'ezhou': { name_cn: '鄂州', name_en: 'Ezhou', lat: 30.3917, lng: 114.8949, zoom: 11 },
            'dongying': { name_cn: '东营', name_en: 'Dongying', lat: 37.4348, lng: 118.6749, zoom: 11 },
            'dongguan': { name_cn: '东莞', name_en: 'Dongguan', lat: 23.0489, lng: 113.7447, zoom: 11 },
            'dingxi': { name_cn: '定西', name_en: 'Dingxi', lat: 35.5796, lng: 104.6260, zoom: 11 },
            'deyang': { name_cn: '德阳', name_en: 'Deyang', lat: 31.1270, lng: 104.3982, zoom: 11 },
            'dazhou': { name_cn: '达州', name_en: 'Dazhou', lat: 31.2090, lng: 107.5023, zoom: 11 },
            'datong': { name_cn: '大同', name_en: 'Datong', lat: 40.0903, lng: 113.2953, zoom: 11 },
            'daqing': { name_cn: '大庆', name_en: 'Daqing', lat: 46.5904, lng: 125.1032, zoom: 11 },
            'danzhou': { name_cn: '儋州', name_en: 'Danzhou', lat: 19.5175, lng: 109.5784, zoom: 11 },
            'dalian': { name_cn: '大连', name_en: 'Dalian', lat: 38.9140, lng: 121.6147, zoom: 11 },
            'chuzhou': { name_cn: '滁州', name_en: 'Chuzhou', lat: 32.3173, lng: 118.3167, zoom: 11 },
            'chongzuo': { name_cn: '崇左', name_en: 'Chongzuo', lat: 22.4041, lng: 107.3536, zoom: 11 },
            'chongqing': { name_cn: '重庆', name_en: 'Chongqing', lat: 29.4315, lng: 106.9122, zoom: 10 },
            'chizhou': { name_cn: '池州', name_en: 'Chizhou', lat: 30.6654, lng: 117.4894, zoom: 11 },
            'chifeng': { name_cn: '赤峰', name_en: 'Chifeng', lat: 42.2678, lng: 118.8896, zoom: 11 },
            'chenzhou': { name_cn: '郴州', name_en: 'Chenzhou', lat: 25.7708, lng: 113.0320, zoom: 11 },
            'chengdu': { name_cn: '成都', name_en: 'Chengdu', lat: 30.5728, lng: 104.0668, zoom: 10 },
            'chengde': { name_cn: '承德', name_en: 'Chengde', lat: 40.9544, lng: 117.9619, zoom: 11 },
            'changzhou': { name_cn: '常州', name_en: 'Changzhou', lat: 31.7719, lng: 119.9464, zoom: 11 },
            'changzhi': { name_cn: '长治', name_en: 'Changzhi', lat: 36.1951, lng: 113.1143, zoom: 11 },
            'changsha': { name_cn: '长沙', name_en: 'Changsha', lat: 28.2282, lng: 112.9388, zoom: 10 },
            'changde': { name_cn: '常德', name_en: 'Changde', lat: 29.0319, lng: 111.6990, zoom: 11 },
            'changchun': { name_cn: '长春', name_en: 'Changchun', lat: 43.8171, lng: 125.3235, zoom: 10 },
            'cangzhou': { name_cn: '沧州', name_en: 'Cangzhou', lat: 38.3037, lng: 116.8578, zoom: 11 },
            'bozhou': { name_cn: '亳州', name_en: 'Bozhou', lat: 33.8712, lng: 115.7781, zoom: 11 },
            'binzhou': { name_cn: '滨州', name_en: 'Binzhou', lat: 37.3835, lng: 117.9708, zoom: 11 },
            'bijie': { name_cn: '毕节', name_en: 'Bijie', lat: 27.3017, lng: 105.2851, zoom: 11 },
            'benxi': { name_cn: '本溪', name_en: 'Benxi', lat: 41.2944, lng: 123.7700, zoom: 11 },
            'bengbu': { name_cn: '蚌埠', name_en: 'Bengbu', lat: 32.9165, lng: 117.3890, zoom: 11 },
            'beijing': { name_cn: '北京', name_en: 'Beijing', lat: 39.9042, lng: 116.4074, zoom: 10 },
            'bazhong': { name_cn: '巴中', name_en: 'Bazhong', lat: 31.8691, lng: 106.7536, zoom: 11 },
            'bayannur': { name_cn: '巴彦淖尔', name_en: 'Bayannur', lat: 40.7574, lng: 107.3874, zoom: 11 },
            'baoshan': { name_cn: '保山', name_en: 'Baoshan', lat: 25.1204, lng: 99.1670, zoom: 11 },
            'baoji': { name_cn: '宝鸡', name_en: 'Baoji', lat: 34.3610, lng: 107.2372, zoom: 11 },
            'baoding': { name_cn: '保定', name_en: 'Baoding', lat: 38.8737, lng: 115.4648, zoom: 11 },
            'anyang': { name_cn: '安阳', name_en: 'Anyang', lat: 36.0986, lng: 114.3527, zoom: 11 },
            'anshan': { name_cn: '鞍山', name_en: 'Anshan', lat: 41.1106, lng: 122.9945, zoom: 11 },
            'anqing': { name_cn: '安庆', name_en: 'Anqing', lat: 30.5255, lng: 117.0580, zoom: 11 },
            'altai': { name_cn: '阿勒泰', name_en: 'Altai', lat: 47.8484, lng: 88.1396, zoom: 11 },
            'alar': { name_cn: '阿拉尔', name_en: 'Alar', lat: 40.5417, lng: 81.2769, zoom: 11 },
            'aksu': { name_cn: '阿克苏', name_en: 'Aksu', lat: 41.1717, lng: 80.2648, zoom: 11 }
        };

        // 底图配置
        const basemaps = {
            'osm': {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            },
            'carto-light': {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            },
            'carto-dark': {
                url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            },
            'esri-world': {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',
                attribution: '© Esri',
                maxZoom: 19
            },
            'esri-satellite': {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '© Esri',
                maxZoom: 19
            },
            'stamen-toner': {
                url: 'https://tiles.stadiamaps.com/tiles/stamen_toner/{z}/{x}/{y}{r}.png',
                attribution: '© <a href="https://stadiamaps.com/">Stadia Maps</a>, © <a href="https://openmaptiles.org/">OpenMapTiles</a> © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 20
            }
        };

        // 全局变量
        let map;
        let currentLang = 'zh';
        let currentCity = '';
        let currentTransport = 'bus';
        let currentLayer = 'stops';
        let currentBasemap = 'osm';
        let stopsLayer, routesLayer;
        let basemapLayer;
        let legend;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeLanguage();
            initializeMap();
            initializeCitySelect();
            initializeControls();
            animateStats();
        });

        function initializeLanguage() {
            const langButtons = document.querySelectorAll('.lang-btn');
            langButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    langButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLang = btn.dataset.lang;
                    updateLanguage();
                    updateCitySelect();
                    if (legend) updateLegend();
                    document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
                });
            });
        }

        function updateLanguage() {
            const elements = document.querySelectorAll('[data-key]');
            elements.forEach(element => {
                const key = element.dataset.key;
                if (translations[currentLang][key]) {
                    if (key === 'map-info') {
                        element.innerHTML = translations[currentLang][key];
                    } else {
                        element.textContent = translations[currentLang][key];
                    }
                }
            });

            // 切换作者信息和数据集描述的语言显示
            const authorsContents = document.querySelectorAll('[data-lang-content]');
            authorsContents.forEach(element => {
                const lang = element.dataset.langContent;
                if (lang === currentLang) {
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        }

        function initializeMap() {
            // 创建地图
            map = L.map('map', {
                center: [35.0, 105.0],
                zoom: 5,
                zoomControl: true,
                attributionControl: true
            });
            
            // 初始化底图
            updateBasemap();

            // 初始化图层
            stopsLayer = L.layerGroup();
            routesLayer = L.layerGroup();
        }

        function updateBasemap() {
            if (basemapLayer) {
                map.removeLayer(basemapLayer);
            }
            
            const basemapConfig = basemaps[currentBasemap];
            if (!basemapConfig) return;
            
            const options = {
                attribution: basemapConfig.attribution,
                maxZoom: basemapConfig.maxZoom || 18,
                crossOrigin: true
            };
            
            if (basemapConfig.subdomains) {
                options.subdomains = basemapConfig.subdomains;
            }
            
            basemapLayer = L.tileLayer(basemapConfig.url, options);
            basemapLayer.addTo(map);
        }

        function initializeCitySelect() {
            const citySelect = document.getElementById('citySelect');
            updateCitySelect();

            citySelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    currentCity = e.target.value;
                    switchCity(currentCity);
                } else {
                    clearData();
                    map.setView([35.0, 105.0], 5);
                }
            });
        }

        function updateCitySelect() {
            const citySelect = document.getElementById('citySelect');
            const selectedValue = citySelect.value;
            
            citySelect.innerHTML = `<option value="">-- ${currentLang === 'zh' ? '选择城市' : 'Select City'} --</option>`;
            
            // 按城市名称排序
            const sortedCities = Object.entries(cities).sort(([,a], [,b]) => {
                const nameA = currentLang === 'zh' ? a.name_cn : a.name_en;
                const nameB = currentLang === 'zh' ? b.name_cn : b.name_en;
                return nameA.localeCompare(nameB);
            });
            
            sortedCities.forEach(([cityKey, city]) => {
                const option = document.createElement('option');
                option.value = cityKey;
                option.textContent = currentLang === 'zh' ? city.name_cn : city.name_en;
                if (cityKey === selectedValue) option.selected = true;
                citySelect.appendChild(option);
            });
        }

        function initializeControls() {
            // 交通类型按钮
            const transportButtons = document.querySelectorAll('.transport-btn');
            transportButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    transportButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTransport = btn.dataset.transport;
                    if (currentCity) {
                        loadCityData(currentCity);
                    }
                });
            });

            // 图层显示按钮
            const layerButtons = document.querySelectorAll('.layer-btn');
            layerButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    layerButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentLayer = btn.dataset.layer;
                    updateMapLayers();
                });
            });

            // 底图选择
            const basemapSelect = document.getElementById('basemapSelect');
            basemapSelect.addEventListener('change', (e) => {
                currentBasemap = e.target.value;
                updateBasemap();
            });
        }

        function switchCity(cityKey) {
            const city = cities[cityKey];
            if (city) {
                map.setView([city.lat, city.lng], city.zoom);
                loadCityData(cityKey);
            }
        }

        function clearData() {
            if (stopsLayer) stopsLayer.clearLayers();
            if (routesLayer) routesLayer.clearLayers();
            updateMapLayers();
            updateDataInfo(null);
            if (legend) {
                map.removeControl(legend);
                legend = null;
            }
        }

        function showLoading() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
            }
        }

        function hideLoading() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }

        async function loadCityData(cityKey) {
            showLoading();
            
            // 清除现有数据
            stopsLayer.clearLayers();
            routesLayer.clearLayers();
            
            if (legend) {
                map.removeControl(legend);
                legend = null;
            }
            
            try {
                // 构造文件名 - 修改为全小写
                const stopsFileName = `${cityKey}_${currentTransport}_stops.geojson`;
                const routesFileName = `${cityKey}_${currentTransport}_routes.geojson`;
                
                let hasData = false;
                
                // 加载站点数据
                try {
                    const stopsResponse = await fetch(SERVER_BASE_URL + stopsFileName);
                    if (stopsResponse.ok) {
                        const stopsData = await stopsResponse.json();
                        loadGeoJSONStops(stopsData);
                        hasData = true;
                    }
                } catch (error) {
                    console.log('站点数据加载失败:', error);
                }
                
                // 加载线路数据
                try {
                    const routesResponse = await fetch(SERVER_BASE_URL + routesFileName);
                    if (routesResponse.ok) {
                        const routesData = await routesResponse.json();
                        loadGeoJSONRoutes(routesData);
                        hasData = true;
                    }
                } catch (error) {
                    console.log('线路数据加载失败:', error);
                }
                
                if (hasData) {
                    updateMapLayers();
                    updateDataInfo(cityKey);
                    createLegend();
                } else {
                    showErrorMessage(currentLang === 'zh' ? '该城市暂无数据' : 'No data available for this city');
                }
                
            } catch (error) {
                console.error('数据加载错误:', error);
                showErrorMessage(currentLang === 'zh' ? '数据加载失败，请检查网络连接' : 'Data loading failed, please check network connection');
            }
            
            hideLoading();
        }

        function loadGeoJSONStops(geojson) {
            const stopsColor = currentTransport === 'bus' ? '#ff7800' : '#0066cc';
            
            L.geoJSON(geojson, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: stopsColor,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function (feature, layer) {
                    const props = feature.properties;
                    const transportIcon = currentTransport === 'bus' ? 'fa-bus' : 'fa-subway';
                    
                    const popupContent = `
                        <div style="font-size: 14px; min-width: 200px;">
                            <h4 style="margin: 5px 0; color: #333; display: flex; align-items: center; gap: 8px;">
                                <i class="fas ${transportIcon}"></i> 
                                ${props.name || props.stop_name || (currentLang === 'zh' ? '未知站点' : 'Unknown Stop')}
                            </h4>
                            <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
                            <p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '坐标' : 'Coordinates'}:</strong> ${feature.geometry.coordinates[1].toFixed(6)}, ${feature.geometry.coordinates[0].toFixed(6)}</p>
                            ${props.route_id ? `<p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '线路ID' : 'Route ID'}:</strong> ${props.route_id}</p>` : ''}
                            ${props.city ? `<p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '城市' : 'City'}:</strong> ${props.city}</p>` : ''}
                            <p style="margin: 3px 0; font-size: 12px; color: #666;"><strong>${currentLang === 'zh' ? '数据类型' : 'Data Type'}:</strong> ${currentTransport === 'bus' ? (currentLang === 'zh' ? '公交站点' : 'Bus Stop') : (currentLang === 'zh' ? '地铁站点' : 'Metro Station')}</p>
                        </div>
                    `;
                    layer.bindPopup(popupContent);
                    
                    // 添加悬停效果
                    layer.on('mouseover', function() {
                        this.setStyle({
                            radius: 8,
                            weight: 2
                        });
                    });
                    
                    layer.on('mouseout', function() {
                        this.setStyle({
                            radius: 6,
                            weight: 1
                        });
                    });
                }
            }).addTo(stopsLayer);
        }

        function loadGeoJSONRoutes(geojson) {
            const routeColors = ['#3388ff', '#ff6600', '#33cc33', '#cc3333', '#9933cc', '#33cccc', '#ff9900', '#cc9933'];
            
            L.geoJSON(geojson, {
                style: function (feature, index) {
                    const colorIndex = feature.properties.route_id ? 
                        Math.abs(feature.properties.route_id.toString().charCodeAt(0)) % routeColors.length : 
                        Math.floor(Math.random() * routeColors.length);
                    
                    return {
                        color: routeColors[colorIndex],
                        weight: 4,
                        opacity: 0.8
                    };
                },
                onEachFeature: function (feature, layer) {
                    const props = feature.properties;
                    const routeType = currentTransport === 'bus' ? 
                        (currentLang === 'zh' ? '公交线路' : 'Bus Route') : 
                        (currentLang === 'zh' ? '地铁线路' : 'Metro Line');
                    
                    const popupContent = `
                        <div style="font-size: 14px; min-width: 250px;">
                            <h4 style="margin: 5px 0; color: #333;">
                                <i class="fas ${currentTransport === 'bus' ? 'fa-bus' : 'fa-subway'}"></i> 
                                ${props.name || props.route_name || (currentLang === 'zh' ? '未知线路' : 'Unknown Route')}
                            </h4>
                            <hr style="margin: 8px 0; border: none; border-top: 1px solid #eee;">
                            <p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '类型' : 'Type'}:</strong> ${routeType}</p>
                            ${props.route_id ? `<p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '线路ID' : 'Route ID'}:</strong> ${props.route_id}</p>` : ''}
                            ${props.city ? `<p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '城市' : 'City'}:</strong> ${props.city}</p>` : ''}
                            ${props.operator ? `<p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '运营商' : 'Operator'}:</strong> ${props.operator}</p>` : ''}
                            ${props.from && props.to ? `<p style="margin: 3px 0;"><strong>${currentLang === 'zh' ? '起终点' : 'From-To'}:</strong> ${props.from} → ${props.to}</p>` : ''}
                            <p style="margin: 3px 0; font-size: 12px; color: #666;"><strong>${currentLang === 'zh' ? '数据源' : 'Data Source'}:</strong> CPTOND-2025</p>
                        </div>
                    `;
                    layer.bindPopup(popupContent);
                    
                    // 添加悬停效果
                    layer.on('mouseover', function() {
                        this.setStyle({
                            weight: 6,
                            opacity: 1
                        });
                    });
                    
                    layer.on('mouseout', function() {
                        this.setStyle({
                            weight: 4,
                            opacity: 0.8
                        });
                    });
                }
            }).addTo(routesLayer);
        }

        function updateMapLayers() {
            // 清除所有图层
            if (map.hasLayer(stopsLayer)) map.removeLayer(stopsLayer);
            if (map.hasLayer(routesLayer)) map.removeLayer(routesLayer);
            
            // 根据选择添加图层
            switch(currentLayer) {
                case 'stops':
                    map.addLayer(stopsLayer);
                    break;
                case 'routes':
                    map.addLayer(routesLayer);
                    break;
                case 'both':
                    map.addLayer(routesLayer);
                    map.addLayer(stopsLayer);
                    break;
            }
        }

        function createLegend() {
            if (legend) {
                map.removeControl(legend);
            }
            
            legend = L.control({ position: 'bottomright' });
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                updateLegendContent(div);
                return div;
            };
            legend.addTo(map);
        }

        function updateLegend() {
            if (legend) {
                const legendDiv = legend.getContainer().querySelector('.legend');
                if (legendDiv) {
                    updateLegendContent(legendDiv);
                }
            }
        }

        function updateLegendContent(div) {
            const city = cities[currentCity];
            const cityName = city ? (currentLang === 'zh' ? city.name_cn : city.name_en) : '';
            const transportType = currentTransport === 'bus' ? 
                (currentLang === 'zh' ? '公交' : 'Bus') : 
                (currentLang === 'zh' ? '地铁' : 'Metro');
            
            let legendHTML = `
                <h4>
                    <i class="fas ${currentTransport === 'bus' ? 'fa-bus' : 'fa-subway'}"></i>
                    ${cityName} ${transportType}
                </h4>
            `;
            
            if (currentLayer === 'stops' || currentLayer === 'both') {
                legendHTML += `
                    <div class="legend-item">
                        <span class="legend-point" style="background-color: ${currentTransport === 'bus' ? '#ff7800' : '#0066cc'}"></span>
                        <span>${currentLang === 'zh' ? '站点' : 'Stops'}</span>
                    </div>
                `;
            }
            
            if (currentLayer === 'routes' || currentLayer === 'both') {
                legendHTML += `
                    <div class="legend-item">
                        <span class="legend-line" style="background-color: ${currentTransport === 'bus' ? '#3388ff' : '#ff6600'}"></span>
                        <span>${currentLang === 'zh' ? '线路' : 'Routes'}</span>
                    </div>
                `;
            }
            
            div.innerHTML = legendHTML;
        }

        function updateDataInfo(cityKey) {
            const currentDataInfo = document.getElementById('currentDataInfo');
            
            if (!cityKey) {
                currentDataInfo.innerHTML = `
                    <div class="success-message">
                        <i class="fas fa-hand-pointer"></i>
                        <span>${currentLang === 'zh' ? '请选择城市查看详细数据属性信息' : 'Please select a city to view detailed data attributes'}</span>
                    </div>
                `;
                return;
            }
            
            const city = cities[cityKey];
            const cityName = currentLang === 'zh' ? city.name_cn : city.name_en;
            const transportType = currentTransport === 'bus' ? 
                (currentLang === 'zh' ? '公交' : 'Bus') : 
                (currentLang === 'zh' ? '地铁' : 'Metro');
            
            const attributes = currentLang === 'zh' ? [
                { key: 'name/stop_name', desc: '站点或线路名称', type: 'String' },
                { key: 'coordinates', desc: 'GeoJSON坐标 [经度, 纬度]', type: 'Array' },
                { key: 'route_id', desc: '线路唯一标识符', type: 'String/Number' },
                { key: 'city', desc: '所属城市', type: 'String' },
                { key: 'operator', desc: '运营商名称', type: 'String' },
                { key: 'operating_hours', desc: '运营时间', type: 'String' },
                { key: 'fare', desc: '票价信息', type: 'String/Number' },
                { key: 'geometry', desc: 'Shapefile几何数据', type: 'Object' },
                { key: 'spatial_accuracy', desc: '空间定位精度', type: 'Number' }
            ] : [
                { key: 'name/stop_name', desc: 'Stop or route name', type: 'String' },
                { key: 'coordinates', desc: 'GeoJSON coordinates [lng, lat]', type: 'Array' },
                { key: 'route_id', desc: 'Route unique identifier', type: 'String/Number' },
                { key: 'city', desc: 'City name', type: 'String' },
                { key: 'operator', desc: 'Operator name', type: 'String' },
                { key: 'operating_hours', desc: 'Operating hours', type: 'String' },
                { key: 'fare', desc: 'Fare information', type: 'String/Number' },
                { key: 'geometry', desc: 'Shapefile geometry data', type: 'Object' },
                { key: 'spatial_accuracy', desc: 'Spatial positioning accuracy', type: 'Number' }
            ];
            
            currentDataInfo.innerHTML = `
                <div class="success-message">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>${currentLang === 'zh' ? '当前数据' : 'Current Data'}:</strong> ${cityName} - ${transportType}</span>
                </div>
                <div class="data-attributes">
                    ${attributes.map(attr => 
                        `<div class="attribute-item">
                            <strong>${attr.key}:</strong> ${attr.desc}<br>
                            <small style="color: #666;">Type: ${attr.type}</small>
                        </div>`
                    ).join('')}
                    <div class="attribute-item">
                        <strong>${currentLang === 'zh' ? '数据源' : 'Data Source'}:</strong><br>
                        <small>${SERVER_BASE_URL}${cityKey}_${currentTransport}_*.geojson</small>
                    </div>
                    <div class="attribute-item">
                        <strong>${currentLang === 'zh' ? '平均精度' : 'Average Accuracy'}:</strong><br>
                        <small>5.08m (WGS-84)</small>
                    </div>
                </div>
            `;
        }

        function showErrorMessage(message) {
            const currentDataInfo = document.getElementById('currentDataInfo');
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            errorMsg.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> 
                <span><strong>${currentLang === 'zh' ? '错误' : 'Error'}:</strong> ${message}</span>
            `;
            currentDataInfo.innerHTML = '';
            currentDataInfo.appendChild(errorMsg);
        }

        function animateStats() {
            setTimeout(() => {
                animateNumber(document.getElementById('cityCount'), 350);
                animateNumber(document.getElementById('metroCount'), 46);
                animateNumber(document.getElementById('routesLength'), 3408);
            }, 500);
        }

        function animateNumber(element, target, duration = 2000) {
            if (!element) return;
            
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                
                let displayValue;
                if (target >= 1000) {
                    displayValue = (Math.floor(current / 100) / 10).toFixed(1) + 'M';
                } else {
                    displayValue = Math.floor(current) + '';
                }
                element.textContent = displayValue;
            }, 16);
        }
    </script>
</body>
</html>
